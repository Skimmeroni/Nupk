#!/bin/sh

# Where the installation scripts live
NUPK_REPOSITORY="/var/db/nupk/repository"
# Where the manifest files live
NUPK_INSTALLED="/var/db/nupk/installed"
# Where the (g)zipped packages live
NUPK_BINARIES="/var/cache/nupk"
# Where packages are built
NUPK_WORKDIR="/var/tmp/nupk"

error_message() {
	printf "\033[31;1m@\033[0m $1\n"
}

ok_message() {
	printf "\033[32;1m@\033[0m $1\n"
}

warning_message() {
	printf "\033[33;1m@\033[0m $1\n"
}

ask_for_cleanup() {
	printf "Your response: [Y/n] "
	read -r
	if [ $REPLY == 'Y' ] || [ $REPLY == 'y' ]
	then
		rm -rf $1
		ok_message "Removed $1"
	else
		warning_message "$1 untouched"
	fi
}

# Run a build script
build() {
	# TODO: refer to Class/Name as two variables
	PACKAGE_NAME=$(basename $1)
	COMPLETE_NAME=$(echo $1 | tr '/' '-')

	# Create the working directory
	BUILDIR="$NUPK_WORKDIR/$COMPLETE_NAME"
	ok_message "Copying build script and related material..."

	# Stop if the remnants of a previous build attempt are found
	if [ -d $BUILDIR ]
	then
		warning_message "Directory $BUILDIR already exists! Remove it now?"
		ask_for_cleanup $BUILDIR
		# If the directory is still there, i.e. the answer was 'no',
		# respect said choice
		[ ! -d $BUILDIR ] || exit
	fi

	# Does a script actually exist?
	if [ ! -e "$NUPK_REPOSITORY/$1/build-$PACKAGE_NAME.sh" ]
	then
		error_message "A build script for this package could not be found!"
		exit 1
	fi

	# Very stupid hack until we wrap the scripts content into a function
	VERSION=$(grep '^VERSION' "$NUPK_REPOSITORY/$1/build-$PACKAGE_NAME.sh" | awk -F '=' '{print $2}')

	# Copy the entire directory
	cp -r "$NUPK_REPOSITORY/$1" $NUPK_WORKDIR/$COMPLETE_NAME
	cd $BUILDIR

	# Build the package
	ok_message "Building directory prepared. Building $1"
	./build-$PACKAGE_NAME.sh

	# Bail out on failure
	if [ $? != 0 ]
	then
		error_message "Something has gone terribly wrong!"

		# Cleanup, if desired
		warning_message "Remove leftovers in $BUILDIR?"
		ask_for_cleanup $BUILDIR

		exit 1
	else
		# Move the archive to $NUPK_BINARIES
		mv "$COMPLETE_NAME@$VERSION.tar.gz" $NUPK_BINARIES
		ok_message "$1 built and saved in $NUPK_BINARIES"
		
		# Cleanup, if desired
		warning_message "Remove leftovers in $BUILDIR?"
		ask_for_cleanup $BUILDIR
	fi
}

# TODO
#install() {
#}

# TODO
#validate() {
#}

# TODO
#update() {
#}

### THE ACTUAL SCRIPT STARTS HERE ###

while getopts "b:" op
do
	# Check if the main directories exist
	# TODO: also check if their permissions have been set properly
	for i in NUPK_REPOSITORY NUPK_INSTALLED NUPK_BINARIES NUPK_WORKDIR
	do
		D=$(eval 'printf ${'"$i"'}')
		if [ ! -e $D ]
		then
			error_message "Directory $i, set as $D, does not exist!"
			exit 1
		fi
	done

	# Check if the package actually exist
	if [ ! -d "$NUPK_REPOSITORY/$OPTARG" ]
	then
		error_message "Package $OPTARG does not exist!"
		exit 1
	fi

	# Prevent root from running a build script
	if [ $(id -u) == 0 ] && [ $op = 'b' ]
	then
		error_message "Only non-root users can build packages"
		exit 1
	fi

	case $op in
	b)
		build $OPTARG
		;;
	esac
done

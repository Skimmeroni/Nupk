#!/bin/sh

set -u

# Where the installation scripts live
NUPK_REPOSITORY="/var/db/nupk/repository"
# Where the manifest files live
NUPK_INSTALLED="/var/db/nupk/installed"
# Where the (g)zipped packages live
NUPK_BINARIES="/var/cache/nupk"
# Where packages are built
NUPK_WORKDIR="/var/tmp/nupk"

error_message() {
	printf "\033[31;1m@\033[0m \033[1m%s\033[0m\n" "$1"
}

ok_message() {
	printf "\033[32;1m@\033[0m \033[1m%s\033[0m\n" "$1"
}

warning_message() {
	printf "\033[33;1m@\033[0m \033[1m%s\033[0m\n" "$1"
}

fetch_latest_release() {
	V=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
	    "https://repology.org/api/v1/project/$PRETTY_NAME" | \
	    jq -r --arg pretty_name "$PRETTY_NAME" --arg name "$PACKAGE_NAME" \
	    'map(select(.srcname == $pretty_name or .srcname == $name) | select(.status == "newest" or .status == "unique") | .version) | unique | max' | \
	    tr '\-,\_' '.')

	printf "%s\n" "$V"
}

ask_for_cleanup() {
	printf "\033[1mYour response: [Y/n] \033[0m"
	read -r REPLY
	if [ "$REPLY" = 'Y' ] || [ "$REPLY" = 'y' ]
	then
		rm -rf "$1"
		ok_message "Removed $1"
	else
		warning_message "$1 untouched"
	fi
}

check_for_package_consistency() {
	# Check if the package actually exist
	if [ ! -d "$NUPK_REPOSITORY/$1" ]
	then
		error_message "Package $OPTARG does not exist!"
		exit 1
	fi

	# $OPTARG is in the form PACKAGE_CLASS/PACKAGE_NAME
	PACKAGE_CLASS=$(printf "%s\n" "$1" | cut -d / -f 1)
	PACKAGE_NAME=$(printf "%s\n" "$1" | cut -d / -f 2)
	SCRIPT_NAME="build-$PACKAGE_NAME.sh"

	# Does a script actually exist?
	if [ ! -f "$NUPK_REPOSITORY/$1/$SCRIPT_NAME" ]
	then
		error_message "A build script for this package could not be found!"
		exit 1
	fi

	# Very stupid hack until we wrap the scripts content into a function
	VERSION=$(grep '^VERSION' "$NUPK_REPOSITORY/$1/$SCRIPT_NAME" | cut -d = -f 2)
	PRETTY_NAME=$(grep '^PRETTY_NAME' "$NUPK_REPOSITORY/$1/$SCRIPT_NAME" | cut -d = -f 2)

	# Is the VERSION variable around?
	if [ -z "$VERSION" ]
	then
		error_message "The build script for $1 does not contain a VERSION variable!"
		exit 1
	fi

	# Is the PRETTY_NAME variable around?
	if [ -z "$PRETTY_NAME" ]
	then
		error_message "The build script for $1 does not contain a PRETTY_NAME variable!"
		exit 1
	fi
}

check_argnum() {
	if [ "$1" != $(($2 - 1)) ]
	then
		error_message "Wrong number of arguments: expected $1, got $(($2 - 1))"
		exit 1
	fi
}

# b) build a package
# TODO i) install a package
# TODO v) validate a manifest file
# c) compare the current version and the latest version known to Repology
# TODO u) compare all current versions and the latest versions known to Repology
# t) generate a template

while getopts "b:c:t:" op
do
	# Check if the main directories exist
	# TODO: also check if their permissions have been set properly
	for i in NUPK_REPOSITORY NUPK_INSTALLED NUPK_BINARIES NUPK_WORKDIR
	do
		D=$(eval 'printf ${'"$i"'}')
		if [ ! -e "$D" ]
		then
			error_message "Directory $i, set as $D, does not exist!"
			exit 1
		fi
	done

	case $op in
	b)
		# Prevent root from running a build script
		if [ "$(id -u)" = 0 ]
		then
			error_message "Only non-root users can build packages"
			exit 1
		fi

		check_argnum 1 $#
		check_for_package_consistency "$OPTARG"

		PACKAGE_CLASS=$(printf "%s\n" "$OPTARG" | cut -d / -f 1)
		PACKAGE_NAME=$(printf "%s\n" "$OPTARG" | cut -d / -f 2)
		SCRIPT_NAME="build-$PACKAGE_NAME.sh"
		# !!!
		VERSION=$(grep '^VERSION' "$NUPK_REPOSITORY/$OPTARG/$SCRIPT_NAME" | cut -d = -f 2)

		# Where the build will take place
		BUILDIR="$NUPK_WORKDIR/$PACKAGE_CLASS-$PACKAGE_NAME"

		# Stop if the remnants of a previous build attempt are found
		if [ -d "$BUILDIR" ]
		then
			warning_message "Directory $BUILDIR already exists! Remove it now?"
			ask_for_cleanup "$BUILDIR"
			# If the directory is still there, i.e. the answer was 'no',
			# respect said choice
			[ ! -d "$BUILDIR" ] || exit
		fi

		# Copy the entire directory
		ok_message "Copying build script and related material..."
		cp -r "$NUPK_REPOSITORY/$OPTARG" "$BUILDIR"
		cd "$BUILDIR"

		# Build the package
		ok_message "Building directory prepared. Building $OPTARG"
		./"$SCRIPT_NAME"

		# Bail out on failure
		if [ $? != 0 ]
		then
			error_message "Something has gone terribly wrong!"

			# Cleanup, if desired
			warning_message "Remove leftovers in $BUILDIR?"
			ask_for_cleanup "$BUILDIR"

			error_message "Building $OPTARG failed!"
			exit 1
		else
			# Move the archive to $NUPK_BINARIES
			mv "$PACKAGE_CLASS-$PACKAGE_NAME@$VERSION.tar.gz" "$NUPK_BINARIES"
			ok_message "$OPTARG built and saved in $NUPK_BINARIES"

			# Cleanup, if desired
			warning_message "Remove leftovers in $BUILDIR?"
			ask_for_cleanup "$BUILDIR"
		fi
		;;
	c)
		check_argnum 1 $#
		check_for_package_consistency "$OPTARG"

		PACKAGE_NAME=$(printf "%s\n" "$OPTARG" | cut -d / -f 2)
		SCRIPT_NAME="build-$PACKAGE_NAME.sh"
		# !!!
		VERSION=$(grep '^VERSION' "$NUPK_REPOSITORY/$OPTARG/$SCRIPT_NAME" | cut -d = -f 2)
		PRETTY_NAME=$(grep '^PRETTY_NAME' "$NUPK_REPOSITORY/$OPTARG/$SCRIPT_NAME" | cut -d = -f 2)

		REPOLOGY_VERSION=$(fetch_latest_release "$OPTARG")
		printf "You have: %s\nRepology has: %s\n" "$VERSION" "$REPOLOGY_VERSION"
		;;
	t)
		check_argnum 3 $#

		printf "\
		#!/bin/sh\n\
		\n\
		set -eu\n\
		\n\
		PRETTY_NAME=%s\n\
		MAJOR=\n\
		MINOR=\n\
		PATCH=\n\
		VERSION=%s\n\
		\n\
		DESTDIR=\"\$PWD/temporary-destdir\"\n\
		[ -d \$DESTDIR ] || mkdir -p \$DESTDIR\n\
		\n\
		# curl --location --remote-name --skip-existing ???\n\
		# git clone ???\n\
		\n\
		# gzip/xz/bzip2 -cd ???-\$VERSION.tar.gz/xz/bz2 | tar -x\n\
		# cd ???-\$VERSION\n\
		\n\
		# ???\n\
		\n\
		doas chown -R root:root \$DESTDIR\n\
		cd \$DESTDIR\n\
		doas sh -c \"tar -cf - * | gzip > ../%s-%s@\$VERSION.tar.gz\"\n\
		doas rm -rf \$DESTDIR\n" "$3" "$4" "$2" "$3" | tr -d '\t'
		;;
	*)
		error_message "Huh?"
		;;
	esac
done
